<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'">
    <title>Terminal - TermPrompter</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/terminal.css">
    <link rel="stylesheet" href="../node_modules/xterm/css/xterm.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: var(--bg-dark);
            overflow: hidden;
        }

        .terminal-window {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-dark);
        }

        .terminal-window-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-color);
            -webkit-app-region: drag;
        }

        .terminal-window-title {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .terminal-window-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .terminal-window-controls button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .terminal-window-controls button:hover {
            background: var(--bg-light);
            color: var(--text-primary);
        }

        .terminal-window-container {
            flex: 1;
            padding: 8px;
            overflow: hidden;
        }

        #terminalContainer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="terminal-window">
        <div class="terminal-window-header">
            <span class="terminal-window-title">Terminal</span>
            <div class="terminal-window-controls">
                <button id="attachBtn" title="Adjuntar a ventana principal">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="4" width="16" height="16" rx="2" ry="2" />
                        <path d="M9 9h6v6H9z" fill="currentColor" />
                    </svg>
                    Adjuntar
                </button>
            </div>
        </div>
        <div class="terminal-window-container">
            <div id="terminalContainer"></div>
        </div>
    </div>

    <script src="../node_modules/xterm/lib/xterm.js"></script>
    <script src="../node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script>
        // Command buffer for tracking executed commands
        let commandBuffer = '';

        // Handle command input tracking
        function handleCommandInput(data) {
            if (data === '\r' || data === '\n') {
                const command = commandBuffer.trim();
                if (command) {
                    // Send command to main process for auto-advance
                    window.electronAPI.notifyCommandExecuted(command);
                }
                commandBuffer = '';
            } else if (data === '\x7f') {
                // Backspace
                commandBuffer = commandBuffer.slice(0, -1);
            } else if (data === '\x03' || data === '\x15') {
                // Ctrl+C or Ctrl+U - clear buffer
                commandBuffer = '';
            } else if (data.charCodeAt(0) >= 32 && data.charCodeAt(0) < 127) {
                // Printable ASCII
                commandBuffer += data;
            }
        }

        // Initialize terminal
        const terminal = new Terminal({
            theme: {
                background: '#1a1a2e',
                foreground: '#e0e0e0',
                cursor: '#e0e0e0',
                cursorAccent: '#1a1a2e',
                selection: 'rgba(255, 255, 255, 0.3)',
                black: '#1a1a2e',
                red: '#ff6b6b',
                green: '#4ecdc4',
                yellow: '#ffe66d',
                blue: '#4a9eff',
                magenta: '#c792ea',
                cyan: '#89ddff',
                white: '#e0e0e0',
                brightBlack: '#666666',
                brightRed: '#ff8a8a',
                brightGreen: '#7ee2db',
                brightYellow: '#fff59d',
                brightBlue: '#82c4ff',
                brightMagenta: '#e0b0ff',
                brightCyan: '#b2ebf2',
                brightWhite: '#ffffff'
            },
            fontFamily: '"Cascadia Code", "Fira Code", Consolas, monospace',
            fontSize: 14,
            cursorBlink: true,
            cursorStyle: 'bar',
            scrollback: 10000
        });

        const fitAddon = new FitAddon.FitAddon();
        terminal.loadAddon(fitAddon);
        terminal.open(document.getElementById('terminalContainer'));
        fitAddon.fit();

        // Handle resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
            const { cols, rows } = terminal;
            window.electronAPI.terminalResize(cols, rows);
        });

        // Terminal input with command tracking
        terminal.onData(data => {
            window.electronAPI.terminalInput(data);
            handleCommandInput(data);
        });

        // Terminal output
        window.electronAPI.onTerminalData(data => {
            terminal.write(data);
        });

        // Attach button
        document.getElementById('attachBtn').addEventListener('click', () => {
            window.electronAPI.attachTerminal();
        });

        // Initial resize
        setTimeout(() => {
            fitAddon.fit();
            const { cols, rows } = terminal;
            window.electronAPI.terminalResize(cols, rows);
        }, 100);
    </script>
</body>

</html>